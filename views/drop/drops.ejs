<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ðŸ”¥ Fruit Drops</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
body {
    background: linear-gradient(135deg,#d4f7d4,#a3e4a3);
    font-family:'Segoe UI', Tahoma, Geneva, Verdana,sans-serif;
    padding:20px;
    min-height:100vh;
}
.navbar {
    background-color:#2e7d32;
    border-radius:14px;
    padding:14px 22px;
    margin-bottom:25px;
    display:flex;
    justify-content:space-between;
    align-items:center;
    box-shadow:0 4px 12px rgba(0,0,0,0.15);
}
.navbar a {
    color:white;
    font-weight:600;
    margin-left:18px;
    text-decoration:none;
    transition:0.2s;
}
.navbar a:hover { text-decoration:underline; }

h1 {
    color:#1b5e20;
    font-weight:800;
    margin-bottom:30px;
    text-align:center;
    letter-spacing:1px;
    text-shadow:1px 1px 4px rgba(0,0,0,0.1);
}

/* Carousel Cards */
.carousel-item > .row {
    display:flex;
    gap:20px;
    justify-content:center;
}
.carousel-item .col {
    flex: 1 0 0%;
}
@media (max-width:992px){ .carousel-item .col{ flex:0 0 48%; } }
@media (max-width:576px){ .carousel-item .col{ flex:0 0 95%; } }

.card {
    border-radius:15px;
    overflow:hidden;
    transition: transform 0.4s, box-shadow 0.4s;
    position:relative;
    background:#ffffffdd;
}
.card:hover {
    transform:translateY(-8px) scale(1.03);
    box-shadow:0 15px 25px rgba(0,0,0,0.2);
}
.card-img-top {
    height:180px;
    object-fit:cover;
    transition: transform 0.4s ease;
}
.card:hover .card-img-top {
    transform:scale(1.05);
}

/* Featured Badge */
.featured {
    position:absolute;
    top:10px;
    left:10px;
    background:gold;
    color:#333;
    font-size:13px;
    font-weight:bold;
    padding:4px 10px;
    border-radius:10px;
    box-shadow:0 2px 6px rgba(0,0,0,0.15);
    animation: glow 1.5s infinite alternate;
}
@keyframes glow {
    from { box-shadow:0 0 5px gold; }
    to { box-shadow:0 0 18px orange; }
}

/* Countdown */
.countdown {
    font-weight:bold;
    color:#e53935;
    margin:6px 0;
    font-size:14px;
    text-align:center;
    animation:pulse 1.5s infinite alternate;
}
@keyframes pulse {
    from { color:#e53935; }
    to { color:#ff7961; }
}

/* Buttons */
.btn-claim {
    background:linear-gradient(45deg,#43a047,#66bb6a);
    color:white;
    border-radius:12px;
    padding:6px 12px;
    border:none;
    font-weight:600;
    font-size:14px;
    letter-spacing:0.5px;
    transition:all 0.3s ease;
}
.btn-claim:hover {
    background:linear-gradient(45deg,#2e7d32,#388e3c);
    transform:translateY(-2px);
    box-shadow:0 5px 15px rgba(0,0,0,0.3);
}
.btn-outline-success {
    border-radius:10px;
    font-weight:500;
    font-size:14px;
}
.claimed {
    color:#2e7d32;
    font-weight:bold;
    margin-top:8px;
    font-size:14px;
}
.carousel-control-prev-icon,
.carousel-control-next-icon { filter:invert(1) grayscale(100); }
</style>
</head>
<body>

<div class="navbar">
  <div><a href="/">Fruit Drops</a></div>
  <div><a href="/auth/profile">Profile</a> <a href="/api/auth/logout">Logout</a></div>
</div>

<h1>ðŸ”¥ Active Fruit Drops</h1>

<div id="fruitDropsCarousel" class="carousel slide" data-bs-ride="carousel">
  <div class="carousel-inner">
    <% for(let i=0; i<drops.length; i+=3){ %>
    <div class="carousel-item <%= i===0?'active':'' %>">
      <div class="row">
        <% drops.slice(i,i+3).forEach(drop=>{ %>
        <div class="col mb-4">
          <div class="card shadow-sm position-relative">
            <% if(drop.featured){ %>
              <span class="featured">ðŸŒŸ Featured</span>
            <% } %>
            <% if(drop.image){ %>
              <img src="<%= drop.image %>" class="card-img-top" alt="Fruit Image">
            <% } %>
            <div class="card-body d-flex flex-column">
              <h5 class="card-title text-center"><%= drop.title %></h5>
              <p class="text-center"><%= drop.description %></p>
              <p class="text-center">
                <strong>Price:</strong>
                <% if(user.isMember){ %>
                  â‚¹<%= drop.finalPrice.toFixed(2) %>
                  <% if(drop.discount){ %> (<%= drop.discount %>% off) <% } %>
                <% } else { %>
                  <em>Membership required</em>
                <% } %>
              </p>
              <p class="countdown" id="countdown-<%= drop._id %>">Loading countdown...</p>
              <p class="text-center"><strong>Ends at:</strong> <%= drop.endTime.toLocaleString() %></p>
              <div class="mt-auto text-center">
                <a href="/drops/<%= drop._id %>" class="btn btn-outline-success mb-2">View Details</a>
                <% if(user.isMember){ %>
                  <% if(!drop.alreadyClaimed){ %>
                    <form method="POST" action="/drops/<%= drop._id %>/claim">
                      <button type="submit" class="btn-claim">Claim Drop</button>
                    </form>
                  <% } else { %>
                    <p class="claimed">âœ… Claimed</p>
                  <% } %>
                <% } else { %>
                  <p><em>Membership required to claim</em></p>
                <% } %>
              </div>
            </div>
          </div>
        </div>
        <% }) %>
      </div>
    </div>
    <% } %>
  </div>

  <button class="carousel-control-prev" type="button" data-bs-target="#fruitDropsCarousel" data-bs-slide="prev">
    <span class="carousel-control-prev-icon"></span>
    <span class="visually-hidden">Previous</span>
  </button>
  <button class="carousel-control-next" type="button" data-bs-target="#fruitDropsCarousel" data-bs-slide="next">
    <span class="carousel-control-next-icon"></span>
    <span class="visually-hidden">Next</span>
  </button>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<!-- Countdown Scripts -->
<% drops.forEach(drop=>{ %>
<script>
(function(){
  const endTime = <%= drop.endTime.getTime() %>;
  const countdownEl = document.getElementById("countdown-<%= drop._id %>");

  function updateCountdown(){
    const now = Date.now();
    const distance = endTime - now;

    if(distance <=0){
      countdownEl.innerHTML = "Drop Ended";
      countdownEl.style.color="#777";
      return;
    }

    const totalSeconds = Math.floor(distance/1000);
    const minutes = Math.floor(totalSeconds/60);
    const seconds = totalSeconds % 60;

    countdownEl.innerHTML = `â³ ${minutes}m ${seconds}s left`;
  }

  updateCountdown();
  setInterval(updateCountdown,1000);
})();
</script>
<% }) %>

</body>
</html>
