<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Fruit Drops</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
body { background: linear-gradient(135deg,#d4f7d4,#a3e4a3); font-family:'Segoe UI', Tahoma, Geneva, Verdana,sans-serif; padding:20px; }
.navbar { background-color:#2e7d32; border-radius:14px; padding:14px 22px; margin-bottom:25px; display:flex; justify-content:space-between; align-items:center; box-shadow:0 4px 12px rgba(0,0,0,0.15);}
.navbar a { color:white; font-weight:600; margin-left:18px; text-decoration:none; transition:0.2s; }
.navbar a:hover { text-decoration:underline; }
h1 { color:#1b5e20; font-weight:800; margin-bottom:20px; text-align:center; letter-spacing:1px; text-shadow:1px 1px 4px rgba(0,0,0,0.1);}
.carousel-item { background:white; border-radius:15px; padding:18px; box-shadow:0 4px 12px rgba(0,128,0,0.2); text-align:center; min-height:300px; transition:all 0.3s ease;}
.carousel-item:hover { transform:translateY(-3px); box-shadow:0 8px 20px rgba(0,128,0,0.25);}
.carousel-item img { border-radius:10px; max-width:60%; margin:10px auto; transition:0.3s ease;}
.featured { background:gold; color:#333; font-size:14px; font-weight:bold; padding:4px 10px; border-radius:10px; margin-left:10px; box-shadow:0 2px 6px rgba(0,0,0,0.15);}
.btn-claim { background-color:#2e7d32; color:white; border-radius:12px; padding:6px 14px; border:none; font-weight:600; font-size:14px; letter-spacing:0.5px; transition:all 0.3s ease; margin-top:8px; }
.btn-claim:hover { background-color:#1b5e20; transform:scale(1.05);}
.btn-outline-success { border-radius:10px; font-weight:500; font-size:14px;}
.claimed { color:#2e7d32; font-weight:bold; margin-top:8px; font-size:14px;}
.countdown { font-weight:bold; color:#e53935; margin:6px 0; font-size:14px;}
.carousel-control-prev-icon, .carousel-control-next-icon { filter:invert(1) grayscale(100);}
</style>
</head>
<body>

<div class="navbar">
  <div><a href="/">Fruit Drops</a></div>
  <div><a href="/auth/profile">Profile</a> <a href="/api/auth/logout">Logout</a></div>
</div>

<h1>Active Fruit Drops</h1>

<div id="fruitDropsCarousel" class="carousel slide" data-bs-ride="carousel">
<div class="carousel-inner">

<% drops.forEach((drop,index)=>{ %>
  <div class="carousel-item <%= index===0 ? 'active' : '' %>">
    <h2><%= drop.title %>
      <% if(drop.featured){ %> <span class="featured">Featured</span> <% } %>
    </h2>
    <p><%= drop.description %></p>
    <% if(drop.image){ %>
      <img src="<%= drop.image %>" alt="Fruit Image">
    <% } %>
    <p><strong>Price:</strong>
      <% if(user.isMember){ %>
        ₹<%= drop.finalPrice.toFixed(2) %>
        <% if(drop.discount){ %> (<%= drop.discount %>% off) <% } %>
      <% } else { %>
        <em>Membership required to see price</em>
      <% } %>
    </p>
    <p class="countdown" id="countdown-<%= drop._id %>">Loading countdown...</p>
    <p><strong>Ends at:</strong> <%= drop.endTime.toLocaleString() %></p>
    <a href="/drops/<%= drop._id %>" class="btn btn-outline-success btn-sm mb-2">View Details</a><br>
    <% if(user.isMember){ %>
      <% if(!drop.alreadyClaimed){ %>
        <form method="POST" action="/drops/<%= drop._id %>/claim">
          <button type="submit" class="btn-claim">Claim Drop</button>
        </form>
      <% } else { %>
        <p class="claimed">✅ Claimed</p>
      <% } %>
    <% } else { %>
      <p><em>Membership required to claim this drop.</em></p>
    <% } %>
  </div>
<% }) %>

</div>

<button class="carousel-control-prev" type="button" data-bs-target="#fruitDropsCarousel" data-bs-slide="prev">
  <span class="carousel-control-prev-icon"></span>
  <span class="visually-hidden">Previous</span>
</button>
<button class="carousel-control-next" type="button" data-bs-target="#fruitDropsCarousel" data-bs-slide="next">
  <span class="carousel-control-next-icon"></span>
  <span class="visually-hidden">Next</span>
</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<!-- Countdown -->
<% drops.forEach(drop=>{ %>
<script>
(function(){
  const endTime = <%= drop.endTime.getTime() %>; // Server-side milliseconds
  const countdownEl = document.getElementById("countdown-<%= drop._id %>");

  function updateCountdown(){
    const now = Date.now();
    const distance = endTime - now;

    if(distance <= 0){
      countdownEl.innerHTML = "Drop Ended";
      countdownEl.style.color="#777";
      return;
    }

    const totalSeconds = Math.floor(distance / 1000);
    const minutes = Math.floor(totalSeconds / 60);
    const seconds = totalSeconds % 60;

    countdownEl.innerHTML = `⏳ ${minutes}m ${seconds}s left`;
  }

  updateCountdown();
  setInterval(updateCountdown,1000);
})();
</script>
<% }) %>

</body>
</html>
